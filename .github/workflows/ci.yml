name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Minimal permissions following least-privilege principle
permissions:
  contents: read

jobs:
  lint:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    steps:
      # Pin to full SHA for supply-chain security
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck --version

      - name: Run ShellCheck
        run: |
          shellcheck -x oneclick.sh
          shellcheck -x dev/test.sh
          shellcheck -x tests/helpers/fixtures.bash
          # Check fakebin scripts (allow sourcing)
          for f in tests/helpers/fakebin/*; do
            if [[ -f "$f" ]]; then
              shellcheck -x "$f" || true  # Warn but don't fail on fakebin
            fi
          done

  format:
    name: Format Check (shfmt)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install shfmt
        run: |
          curl -sS https://webinstall.dev/shfmt | bash
          export PATH="$HOME/.local/bin:$PATH"
          shfmt --version

      - name: Check formatting
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          shfmt -d oneclick.sh
          shfmt -d dev/test.sh

  test:
    name: Bats Tests
    runs-on: ubuntu-latest
    needs: [lint]  # Only run tests if lint passes
    strategy:
      matrix:
        os: [ubuntu-latest]
        # Can expand to include other OS variants
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install bats-core
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local
          bats --version

      - name: Run unit tests
        run: |
          if ls tests/unit/*.bats 1>/dev/null 2>&1; then
            bats tests/unit/*.bats
          else
            echo "No unit tests found"
          fi

      - name: Run integration tests
        run: |
          if ls tests/integration/*.bats 1>/dev/null 2>&1; then
            bats tests/integration/*.bats
          else
            echo "No integration tests found"
          fi

  security-scan:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for secrets
        run: |
          # Basic check for common secret patterns
          echo "Checking for potential secrets..."
          if grep -rE '(password|secret|api_key|token)\s*=' --include="*.sh" --include="*.bash" .; then
            echo "WARNING: Potential secrets found. Please review."
            # Don't fail, just warn
          fi

      - name: Verify no force push commands
        run: |
          if grep -rE 'git\s+push.*--force|git\s+push.*-f\s' --include="*.sh" --include="*.bash" .; then
            echo "ERROR: Force push commands found"
            exit 1
          fi
          echo "No force push commands found"

      - name: Verify action SHA pins
        run: |
          # Check that GitHub Actions use SHA pins, not just tags
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [[ -f "$workflow" ]]; then
              echo "Checking $workflow..."
              # Look for uses: statements without SHA (40 hex chars)
              if grep -E 'uses:\s+[^#]+@[^#]+' "$workflow" | grep -vE '@[a-f0-9]{40}'; then
                echo "WARNING: Found actions without SHA pin in $workflow"
                # Don't fail for now, just warn
              fi
            fi
          done
          echo "Security checks complete"

  all-tests-pass:
    name: All Tests Pass
    runs-on: ubuntu-latest
    needs: [lint, format, test, security-scan]
    steps:
      - name: All checks passed
        run: echo "All CI checks passed successfully"
